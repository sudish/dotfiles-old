#!/bin/zsh
#
# Functions to ease building Emacs from the repo
#

EMACS_CC_FLAGS=(CC=clang CXX=clang++ CFLAGS="-O4 -flto\
    -arch x86_64 -m64 -march=core2 -mtune=core2 -mmmx -msse3 -mssse3")
EMACS_CONF_FLAGS=(--verbose --with-ns \
    --without-pop --without-x --with-x-toolkit=no)

sj_vcs () {
    local res
    if [[ -d .git ]] ; then
	res=git
    elif [[ -d .bzr ]] ; then
	res=bzr
    elif [[ -d _darcs ]] ; then
	res=darcs
    fi

    echo $res
}

sj_emacsupdate () {
    local vcs
    vcs=`sj_vcs`

    $vcs tag --force sj-pull >/dev/null 2>&1 # last HEAD, aka HEAD@{1}
    $vcs pull
}

sj_emacsconfigure () {
    print -z $EMACS_CC_FLAGS `sj_configure` $EMACS_CONF_FLAGS
}

sj_emacsbuild () {
    local vcs build_dir

    rm -rf sj-build.*
    build_dir=sj-build.$$

    sh ./autogen.sh
    mkdir $build_dir || { echo "couldn't mkdir $build_dir: $!"; return 1 }
    cd $build_dir

    env "$EMACS_CC_FLAGS[@]" `sj_configure` "$EMACS_CONF_FLAGS[@]" \
	&& nice -n 20 make -j3 \
	&& nice -n 20 make install \
	&& `sj_vcs` tag --force sj-build
}

sj_emacsinstall () {
    local old new bak

    old=/Applications/Emacs.app
    new=nextstep/Emacs.app
    bak=/tmp/Emacs-$(date -r $old '+%s').app

    if [[ -x $new ]]; then
	mv $old $bak \
	    && mv $new $old \
	    && cd .. \
	    && `sj_vcs` tag --force sj-install \
	    && rm -rf sj-build.*
    else
	echo "$new doesn't exist"
    fi
}
